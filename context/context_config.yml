# context_config
version: "1.3"

#  Definici贸n de entidades globales
entities:
  # ============================================================================
  #  CORE BUSINESS ENTITIES (Lookup Tables desde CSV)
  # ============================================================================
  producto:
    type: text
    patterns: []
    lookup_table: true
  proveedor:
    type: text  
    patterns: []
    lookup_table: true
  categoria:
    type: text
    patterns: []
    lookup_table: true
  ingrediente_activo:
    type: text
    patterns: []
    lookup_table: true
  compuesto:
    type: text
    patterns: []
    lookup_table: true
  
  # ============================================================================
  #  STATIC ENTITIES (Patterns en entidades.yml)
  # ============================================================================
  animal:
    type: text
    patterns: []
    lookup_table: false
    pattern_source: "entidades.yml"
    entity_category: "static"
  dosis:
    type: text
    patterns: ["mg", "ml", "g", "comprimidos", "c谩psulas"]
    lookup_table: false
    pattern_source: "entidades.yml"
    entity_category: "static"
  cantidad:
    type: text
    patterns: ["caja", "blister", "ampolla", "frasco"]
    lookup_table: false
    pattern_source: "entidades.yml"
    entity_category: "static"
  dia:
    type: text
    patterns: ["lunes", "martes", "mi茅rcoles", "jueves", "viernes", "s谩bado", "domingo"]
    lookup_table: false
    pattern_source: "entidades.yml"
    entity_category: "static"
  fecha:
    type: text
    patterns: []
    lookup_table: false
    pattern_source: "entidades.yml"
    entity_category: "static"
  estado:
    type: text
    patterns: ["nuevo", "en oferta", "con descuento", "con bonificaci贸n", "con poco stock", "disponible", "agotado"]
    lookup_table: false
    pattern_source: "entidades.yml"
    entity_category: "static"
  indicador_temporal:
    type: text
    patterns: ["nuevo", "reciente", "hace poco", "esta semana", "este mes", "煤ltimamente", "ahora", "hoy"]
    lookup_table: false
    pattern_source: "entidades.yml"
    entity_category: "static"
  sentimiento_positivo:
    type: text
    patterns: ["genial", "perfecto", "excelente", "buen铆simo", "me gusta", "est谩 bien"]
    lookup_table: false
    pattern_source: "entidades.yml"
    entity_category: "static"
  sentimiento_negativo:
    type: text
    patterns: ["malo", "terrible", "p茅simo", "in煤til", "no sirve", "frustrado", "molesto", "enojado"]
    lookup_table: false
    pattern_source: "entidades.yml"
    entity_category: "static"
  rechazo_total:
    type: text
    patterns: ["nada", "no quiero nada", "d茅jame", "basta", "ya no", "stop"]
    lookup_table: false
    pattern_source: "entidades.yml"
    entity_category: "static"
  intencion_buscar:
    type: text
    patterns: ["buscar", "encontrar", "necesito", "quiero", "me hace falta"]
    lookup_table: false
    pattern_source: "entidades.yml"
    entity_category: "static"
  solicitud_ayuda:
    type: text
    patterns: ["ayuda", "help", "no entiendo", "c贸mo", "expl铆came"]
    lookup_table: false
    pattern_source: "entidades.yml"
    entity_category: "static"

  # ============================================================================
  #  DYNAMIC ENTITIES (Patrones num茅ricos/regex)
  # ============================================================================
  cantidad_descuento:
    type: text
    patterns: []
    lookup_table: false
    regex_pattern: true
    entity_category: "dynamic"
    value_range: "1-99"
    description: "Porcentajes, ofertas tipo 2x1, 3x2"
  cantidad_bonificacion:
    type: text
    patterns: []
    lookup_table: false
    regex_pattern: true
    entity_category: "dynamic"
    value_range: "1-99"
    description: "Bonificaciones, regalos, ofertas m煤ltiples"
  cantidad_stock:
    type: text
    patterns: []
    lookup_table: false
    regex_pattern: true
    entity_category: "dynamic"
    value_range: "descriptive"
    description: "Estados de stock, cantidades disponibles"

#  Configuraci贸n de patterns para generaci贸n NLU
entity_patterns_config:
  patterns_file: "entidades.yml"
  
  # Solo entidades est谩ticas van en entidades.yml
  static_entities:
    - animal
    - dosis
    - cantidad
    - estado
    - indicador_temporal
    - sentimiento_positivo
    - sentimiento_negativo
    - rechazo_total
    - intencion_buscar
    - solicitud_ayuda
    - dia
    - fecha
  
  # Entidades din谩micas se manejan por regex o rangos
  dynamic_entities:
    - cantidad_descuento
    - cantidad_bonificacion
    - cantidad_stock
  
  generation_config:
    max_attempts_per_template: 100
    avoid_duplicates: true
    min_examples_per_intent: 20
    max_examples_per_intent: 100
    dynamic_entity_handling: "regex"

#  Configuraci贸n de entidades din谩micas
dynamic_entities_config:
  cantidad_descuento:
    regex_patterns:
      - r'\d{1,2}%\s?(de\s?)?descuento'
      - r'\d{1,2}%\s?off'
      - r'\d+x\d+'
      - r'(\d{1,2})?\s?%'
    example_values: ["10%", "20%", "50%", "2x1", "3x2"]
    
  cantidad_bonificacion:
    regex_patterns:
      - r'\d{1,2}%\s?(de\s?)?bonificaci贸n'
      - r'\d+x\d+\s?bonificaci贸n'
      - r'lleva\s?\d+\s?paga\s?\d+'
    example_values: ["10%", "2x1", "3x2", "lleva 2 paga 1"]
    
  cantidad_stock:
    regex_patterns:
      - r'\d+\s?unidades?'
      - r'stock\s?(limitado|agotado|disponible)'
      - r'(pocas?|muchas?|煤ltimas?)\s?unidades?'
    example_values: ["10 unidades", "pocas unidades", "stock limitado"]

#  Definici贸n de slots globales
slots:
  # Slots para entidades detectadas
  producto:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: producto
  proveedor:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: proveedor
  categoria:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: categoria
  ingrediente_activo:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: ingrediente_activo
  compuesto:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: compuesto
      - type: from_entity
        entity: ingrediente_activo
  dosis:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: dosis
  cantidad:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: cantidad
  animal:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: animal
  estado:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: estado
  indicador_temporal:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: indicador_temporal
  dia:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: dia
  fecha:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: fecha
        
  # Slots para entidades din谩micas
  cantidad_descuento:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: cantidad_descuento
  cantidad_bonificacion:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: cantidad_bonificacion
  cantidad_stock:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: cantidad_stock
  
  # Slots de control de conversaci贸n
  user_sentiment:
    type: categorical
    values: ["positive", "negative", "neutral", "rejection"]
    initial_value: "neutral"
    influence_conversation: false
    mappings:
      - type: custom
  last_intent_flow:
    type: text
    influence_conversation: false
    mappings:
      - type: custom
  pedido_incompleto:
    type: bool
    initial_value: false
    influence_conversation: false
    mappings:
      - type: custom
  user_engagement_level:
    type: categorical
    values: ["neutral", "engaged", "needs_help", "confused", "friendly", 
             "collaborative", "reset", "disengaged", "interested", "needs_guidance", "satisfied"]
    influence_conversation: false
    mappings:
      - type: custom

#  Definici贸n de intents
intents:
  # ----------- Small Talk -----------
  saludo:
    tipo: template
    grupo: small_talk
    action: action_smalltalk_situacion
    response: utter_saludo
    context_switch: false
    entities: []
    next_intents:
      - preguntar_como_estas
      - busqueda
      - pedir_chiste

  preguntar_como_estas:
    tipo: ejemplos
    grupo: small_talk
    action: action_smalltalk_situacion
    response: utter_preguntar_como_estas
    context_switch: false
    entities: []
    next_intents:
      - responder_como_estoy
      - responder_estoy_bien

  responder_como_estoy:
    tipo: template
    grupo: small_talk
    action: action_smalltalk_situacion
    response: utter_responder_como_estoy
    context_switch: false
    entities: ["sentimiento_positivo", "sentimiento_negativo"]
    next_intents:
      - busqueda
      - small_talk

  responder_estoy_bien:
    tipo: ejemplos
    grupo: small_talk
    action: action_smalltalk_situacion
    response: utter_responder_estoy_bien
    context_switch: false
    entities: ["sentimiento_positivo"]
    next_intents:
      - busqueda
      - small_talk

  despedida:
    tipo: ejemplos
    grupo: small_talk
    action: action_smalltalk_situacion
    response: utter_despedida
    context_switch: false
    entities: ["sentimiento_positivo", "sentimiento_negativo"]
    next_intents: []

  pedir_chiste:
    tipo: ejemplos
    grupo: small_talk
    action: action_smalltalk_situacion
    response: utter_pedir_chiste
    context_switch: false
    entities: []
    next_intents:
      - reirse_chiste
      - busqueda
      - agradecimiento
      - small_talk

  reirse_chiste:
    tipo: template
    grupo: small_talk
    action: action_smalltalk_situacion
    response: utter_reirse_chiste
    context_switch: false
    entities: ["sentimiento_positivo"]
    next_intents:
      - busqueda
      - small_talk

  # ----------- Busqueda / Funcionalidades -----------
  buscar_producto:
    tipo: template
    grupo: busqueda
    action: action_busqueda_situacion
    response: utter_buscar_producto
    context_switch: false
    entities: ["producto", "proveedor", "categoria", "ingrediente_activo", "compuesto", "dosis", "cantidad", "animal", "estado", "indicador_temporal", "cantidad_stock", "cantidad_bonificacion", "intencion_buscar"]
    validation_rules:
      requires_at_least_one: ["producto", "proveedor", "categoria", "ingrediente_activo", "compuesto"]
      optional: ["dosis", "cantidad", "estado", "indicador_temporal", "cantidad_stock", "cantidad_bonificacion"]
    next_intents:
      - completar_pedido
      - confirmacion
      - busqueda

  buscar_oferta:
    tipo: template
    grupo: busqueda
    action: action_busqueda_situacion
    response: utter_buscar_oferta
    context_switch: false
    entities: ["producto", "proveedor", "categoria", "ingrediente_activo", "compuesto", "dosis", "animal", "estado", "indicador_temporal", "cantidad_stock", "cantidad_descuento", "cantidad_bonificacion", "intencion_buscar"]
    validation_rules:
      requires_at_least_one: ["producto", "proveedor", "categoria", "ingrediente_activo", "compuesto"]
      optional: ["dosis", "estado", "indicador_temporal", "cantidad_stock", "cantidad_descuento", "cantidad_bonificacion"]
    next_intents:
      - confirmacion
      - completar_pedido
      - busqueda

  completar_pedido:
    tipo: template
    grupo: busqueda
    action: action_busqueda_situacion
    response: utter_completar_pedido
    context_switch: false
    entities: ["producto", "proveedor", "categoria", "ingrediente_activo", "compuesto", "dosis", "cantidad", "estado", "indicador_temporal", "cantidad_stock", "cantidad_descuento", "cantidad_bonificacion"]
    next_intents:
      - confirmacion
      - busqueda
      - agradecimiento

  # ----------- Novedades -----------
  consultar_novedades_producto:
    tipo: template
    grupo: busqueda
    action: action_generica
    response: utter_consultar_novedades_producto
    context_switch: false
    entities: ["producto", "proveedor", "categoria", "ingrediente_activo", "animal", "compuesto", "dosis", "indicador_temporal"]
    next_intents:
      - buscar_producto
      - buscar_oferta
      - consultar_recomendaciones_producto
      - agradecimiento

  consultar_novedades_oferta:
    tipo: template
    grupo: busqueda
    action: action_generica
    response: utter_consultar_novedades_oferta
    context_switch: false
    entities: ["producto", "proveedor", "categoria", "ingrediente_activo", "animal", "compuesto", "dosis", "indicador_temporal"]
    next_intents:
      - buscar_oferta
      - consultar_recomendaciones_oferta
      - agradecimiento

  consultar_novedades_generales:
    tipo: ejemplos
    grupo: busqueda
    action: action_generica
    response: utter_consultar_novedades_generales
    context_switch: false
    entities: ["indicador_temporal"]
    next_intents:
      - consultar_novedades_producto
      - consultar_novedades_oferta
      - buscar_producto
      - buscar_oferta

  # ----------- Recomendaciones -----------
  consultar_recomendaciones_producto:
    tipo: template
    grupo: busqueda
    action: action_generica
    response: utter_consultar_recomendaciones_producto
    context_switch: false
    entities: ["producto", "proveedor", "categoria", "ingrediente_activo", "animal", "compuesto", "dosis", "estado", "indicador_temporal", "cantidad_stock"]
    next_intents:
      - buscar_producto
      - buscar_oferta
      - agradecimiento

  consultar_recomendaciones_oferta:
    tipo: template
    grupo: busqueda
    action: action_generica
    response: utter_consultar_recomendaciones_oferta
    context_switch: false
    entities: ["producto", "proveedor", "categoria", "ingrediente_activo", "animal", "compuesto", "dosis", "estado", "indicador_temporal", "cantidad_stock", "cantidad_descuento", "cantidad_bonificacion"]
    next_intents:
      - buscar_oferta
      - agradecimiento

  # ----------- Modificaci贸n de b煤squeda -----------
  modificar_busqueda:
    tipo: template
    grupo: busqueda
    action: action_generic_intent_reporter
    response: utter_modificar_busqueda
    context_switch: true
    entities: ["producto", "proveedor", "categoria", "ingrediente_activo", "animal", "compuesto", "dosis", "cantidad", "estado", "indicador_temporal", "cantidad_stock", "cantidad_descuento", "cantidad_bonificacion"]
    next_intents:
      - buscar_producto
      - buscar_oferta
      - completar_pedido

  # ----------- Confirmaci贸n / Negaci贸n / Agradecimiento -----------
  afirmar:
    tipo: template
    grupo: confirmacion
    action: action_conf_neg_agradecer
    response: utter_afirmar
    context_switch: false
    entities: ["sentimiento_positivo"]
    next_intents: 
      - busqueda
      - small_talk

  denegar:
    tipo: template
    grupo: negacion
    action: action_conf_neg_agradecer
    response: utter_denegar
    context_switch: false
    entities: ["sentimiento_negativo", "rechazo_total"]
    next_intents: 
      - busqueda
      - small_talk

  agradecimiento:
    tipo: template
    grupo: agradecimiento
    action: action_conf_neg_agradecer
    response: utter_agradecimiento
    context_switch: false
    entities: ["sentimiento_positivo"]
    next_intents: 
      - busqueda
      - small_talk

  # ----------- Interrupciones / Off-Flow -----------
  off_topic:
    tipo: template
    grupo: interruptions
    action: action_fallback
    response: utter_off_topic
    context_switch: true
    entities: ["solicitud_ayuda", "sentimiento_negativo", "rechazo_total"]
    next_intents: 
      - busqueda
      - small_talk

  out_of_scope:
    tipo: ejemplos
    grupo: interruptions
    action: action_out_of_scope
    response: utter_out_of_scope
    context_switch: true
    entities: []
    next_intents: 
      - busqueda
      - small_talk

  ambiguity_fallback:
    tipo: ejemplos
    grupo: interruptions
    action: action_clarify_ambiguous
    response: utter_clarify_ambiguous
    context_switch: false
    entities: ["solicitud_ayuda"]
    next_intents:
      - buscar_producto
      - buscar_oferta
      - consultar_novedades_generales

  low_confidence_fallback:
    tipo: ejemplos
    grupo: interruptions
    action: action_low_confidence
    response: utter_low_confidence
    context_switch: false
    entities: ["solicitud_ayuda"]
    next_intents:
      - busqueda
      - small_talk

#  Flow groups
flow_groups:
  small_talk:
    - saludo
    - preguntar_como_estas
    - responder_como_estoy
    - responder_estoy_bien
    - pedir_chiste
    - reirse_chiste
    - despedida
    - agradecimiento

  busqueda:
    - buscar_producto
    - buscar_oferta
    - completar_pedido
    - consultar_novedades_producto
    - consultar_novedades_oferta
    - consultar_novedades_generales
    - consultar_recomendaciones_producto
    - consultar_recomendaciones_oferta
    - modificar_busqueda

  confirmacion:
    - afirmar

  negacion:
    - denegar

  agradecimiento:
    - agradecimiento

  interruptions:
    - off_topic
    - out_of_scope
    - ambiguity_fallback
    - low_confidence_fallback

#  Story starters
story_starters:
  - saludo
  - preguntar_como_estas
  - pedir_chiste
  - despedida
  - buscar_producto
  - buscar_oferta
  - consultar_novedades_producto
  - consultar_novedades_oferta
  - consultar_novedades_generales
  - consultar_recomendaciones_producto
  - consultar_recomendaciones_oferta
  - modificar_busqueda

#  Follow-up only
follow_up_only:
  - responder_como_estoy
  - responder_estoy_bien
  - reirse_chiste
  - afirmar
  - denegar
  - agradecimiento
  - completar_pedido
  - off_topic
  - out_of_scope
  - ambiguity_fallback
  - low_confidence_fallback

#  Configuraci贸n de validaci贸n de contexto
context_validation:
  enabled: true
  action: action_context_validator
  max_switches: 5
  skip_intents:
    - saludo
    - preguntar_como_estas
    - despedida
    - buscar_producto
    - buscar_oferta
    - completar_pedido
    - responder_como_estoy
    - responder_estoy_bien
    - pedir_chiste
    - reirse_chiste

#  Configuraci贸n de sesi贸n
session_config:
  session_expiration_time: 300
  carry_over_slots_to_new_session: true

#  Archivos
synonyms: synonyms.yml
responses: responses.yml
segments: segments.yml
templates: templates.yml
examples: examples.yml

#  Fallback gen茅rico
fallback:
  action: action_fallback
  response: "Perd贸n, no entend铆 lo que quisiste decir."
  threshold: 0.6
  ambiguity_threshold: 0.15